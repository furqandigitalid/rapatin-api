openapi: 3.0.0
info:
  title: Update Schedule
  version: 1.0.0
  description: Spesifikasi untuk memperbarui jadwal rapat pada API Rapatin.
servers:
  - url: https://api.rapatin.id

paths:
  /schedules/{meeting_id}:
    put:
      summary: Merubah Data Jadwal Rapat
      description: |-
        Perbarui jadwal meeting Zoom untuk One-time dan Recurring Schedule.

        **Batasan update (divalidasi server):**
        - **Tidak dapat diubah:** `product_id`, `meeting_id`, `account_id`.
        - `start_date` & `start_time` **tidak dapat diubah** jika `is_used = 1` **atau** tanggal jadwal telah berlalu.
        - PUT bersifat **partial update**: field yang tidak dikirim **tidak diubah**.

        **Petunjuk saat memperbarui jadwal One-time (`recurring = false`):**
        - Dapat diubah: `topic`, `start_date`, `start_time`, `passcode`, dan seluruh pengaturan `is_*`.

        **Petunjuk saat memperbarui jadwal Recurring (`recurring = true`):**
        - **Edit semua occurrence (seri)** — *tanpa* `occurrence_id`:
          - **Tidak dapat mengubah pola pengulangan:** `recurring`, `recurrence`, `repeat_interval`, `end_type`, `end_date`, `end_after_type`, `weekly_days`, `monthly_day`, `monthly_week`.
          - **Tidak dapat diubah:** `start_date` (terlepas dari status `is_used`—sudah dipakai maupun belum).
          - Dapat diubah: `topic`, `passcode`, `start_time`, dan seluruh pengaturan `is_*` **dengan mematuhi batasan umum** (ditolak jika occurrence yang terkena `is_used = 1` atau tanggalnya telah berlalu).
        - **Edit salah satu occurrence** — *dengan* query `occurrence_id`:
          - **Hanya** `start_date` dan/atau `start_time` yang diproses.
          - Seluruh field pola recurring diabaikan: `recurrence`, `repeat_interval`, `weekly_days`, `monthly_day`, `monthly_week`, `end_type`, `end_date`, `end_after_type`.
          - Tetap tunduk pada batasan umum (`is_used = 1` atau tanggal berlalu akan ditolak).
      tags: [Update Schedule]
      parameters:
        - in: path
          name: meeting_id
          required: true
          schema: { type: string, example: "89757997072" }
          description: Zoom Meeting ID dari jadwal.
        - in: query
          name: occurrence_id
          required: false
          schema: { type: string, example: "1756260000000" }
          description: ID occurrence untuk memperbarui **satu occurrence** pada jadwal recurring.
        - in: header
          name: Content-Type
          required: true
          schema: { type: string, example: application/json }
        - in: header
          name: Authorization
          required: true
          schema: { type: string, example: "Bearer {token}" }

      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: "#/components/schemas/UpdateOneTimeBody"
                - $ref: "#/components/schemas/UpdateRecurringAllOccurrencesBody"
                - $ref: "#/components/schemas/UpdateSingleOccurrenceBody"
            examples:
              oneTime:
                summary: One-time Schedule
                value:
                  recurring: false
                  topic: "Weekly Team Sync (reschedule)"
                  start_date: "2025-08-25"
                  start_time: "15:30"
              recurringAll:
                summary: Recurring (All Occurrences / Series)
                value:
                  recurring: true
                  topic: "Weekly Sales Meeting (rename)"
                  start_time: "10:30"
                  is_meeting_registration: true
                  is_mute_participant_upon_entry: true
              recurringSingle:
                summary: Recurring (Single Occurrence / This occurrence)
                value:
                  recurring: true
                  start_date: "2025-08-27"
                  start_time: "10:00"

      responses:
        '200':
          description: Schedule updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScheduleUpdateSuccessResponse"
              examples:
                updatedOneTime:
                  summary: One-time updated
                  value:
                    response: { status: success, status_code: 200, message: Schedule updated successfully }
                    data:
                      id: 110
                      topic: "Weekly Team Sync (reschedule)"
                      passcode: "123456"
                      recurring: false
                      start_date: "2025-08-25"
                      start_time: "15:30:00"
                      meeting_id: "81911244410"
                      occurence_id: null
                      join_url: "https://us06web.zoom.us/j/81911244410?pwd=egGYk70..."
                      registration_url: null
                      waiting_room: 1
                      is_meeting_registration: false
                      is_meeting_qna: false
                      is_language_interpretation: false
                      is_mute_participant_upon_entry: true
                      is_req_permission_to_unmute_participants: false
                      editable: true
                      is_used: false
                      created_at: "2025-08-22T01:36:06.000000Z"
                      updated_at: "2025-08-23T05:01:00.000000Z"
                      product: { id: 1, name: "Meeting 100 Participants", capacity: 100 }
                      account: { id: 13, name: "Space 11" }
                      recurring_data:
                        total_recurring: 0
                        recurrence: null
                        repeat_interval: null
                        monthly_day: null
                        monthly_week: null
                        weekly_days: null
                        end_type: null
                        end_date: null
                        end_after_type: null
                updatedSeries:
                  summary: Recurring (all occurrences) updated
                  value:
                    response: { status: success, status_code: 200, message: Schedule updated successfully }
                    data:
                      id: 111
                      topic: "Weekly Sales Meeting (rename)"
                      passcode: "987654"
                      recurring: true
                      start_date: "2025-08-24"
                      start_time: "10:30:00"
                      meeting_id: "89757997072"
                      occurence_id: "1756087200000"
                      join_url: "https://us06web.zoom.us/j/89757997072?pwd=dn3pRow..."
                      registration_url: "https://us06web.zoom.us/meeting/register/xxxx"
                      waiting_room: 1
                      is_meeting_registration: true
                      is_meeting_qna: true
                      is_language_interpretation: false
                      is_mute_participant_upon_entry: true
                      is_req_permission_to_unmute_participants: true
                      editable: true
                      is_used: false
                      created_at: "2025-08-22T01:37:01.000000Z"
                      updated_at: "2025-08-23T06:00:00.000000Z"
                      product: { id: 1, name: "Meeting 100 Participants", capacity: 100 }
                      account: { id: 13, name: "Space 11" }
                      recurring_data:
                        total_recurring: 11
                        recurrence: 2
                        repeat_interval: 1
                        monthly_day: null
                        monthly_week: null
                        weekly_days: null
                        end_type: end_date
                        end_date: "2025-09-30"
                        end_after_type: null
                updatedOccurrence:
                  summary: Recurring (single occurrence) updated
                  value:
                    response: { status: success, status_code: 200, message: Schedule updated successfully }
                    data:
                      id: 112
                      topic: "Weekly Sales Meeting"
                      passcode: "987654"
                      recurring: true
                      start_date: "2025-08-27"
                      start_time: "10:00:00"
                      meeting_id: "89757997072"
                      occurence_id: "1756260000000"
                      join_url: "https://us06web.zoom.us/j/89757997072?pwd=dn3pRow..."
                      registration_url: null
                      waiting_room: 1
                      is_meeting_registration: false
                      is_meeting_qna: true
                      is_language_interpretation: false
                      is_mute_participant_upon_entry: false
                      is_req_permission_to_unmute_participants: true
                      editable: true
                      is_used: false
                      created_at: "2025-08-22T01:37:01.000000Z"
                      updated_at: "2025-08-23T06:10:00.000000Z"
                      product: { id: 1, name: "Meeting 100 Participants", capacity: 100 }
                      account: { id: 13, name: "Space 11" }
                      recurring_data:
                        total_recurring: 11
                        recurrence: 2
                        repeat_interval: 1
                        monthly_day: null
                        monthly_week: null
                        weekly_days: [3]
                        end_type: end_date
                        end_date: "2025-09-30"
                        end_after_type: null
        '400': { description: Validation error }
        '401': { description: Unauthorized (token tidak valid) }
        '422': { description: Unprocessable Entity (kombinasi parameter tidak valid / melanggar batasan update) }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # ---------- REQUEST SCHEMAS (judul muncul di Body card) ----------
    UpdateOneTimeBody:
      title: One-time Schedule
      type: object
      required: [recurring]
      properties:
        recurring:
          type: boolean
          enum: [false]
          description: Harus **false** untuk one-time schedule.
        topic:
          type: string
          maxLength: 200
          description: Judul/topik meeting.
        passcode:
          type: string
          maxLength: 10
          description: Kode sandi rapat.
        start_date:
          type: string
          format: date
          description: "Tanggal pelaksanaan (YYYY-MM-DD)."
        start_time:
          type: string
          description: "Jam pelaksanaan (format 24 jam, HH:MM)."
        is_meeting_registration:
          type: boolean
          description: Apakah membutuhkan registrasi peserta.
        is_meeting_qna:
          type: boolean
          description: Mengatur aktif tidaknya fitur Q&A di ruang Zoom.
        is_language_interpretation:
          type: boolean
          description: Aktifkan fitur juru bahasa.
        is_mute_participant_upon_entry:
          type: boolean
          description: Mute otomatis saat peserta masuk.
        is_req_permission_to_unmute_participants:
          type: boolean
          description: Peserta membutuhkan izin host untuk melakukan unmute.

    UpdateRecurringAllOccurrencesBody:
      title: Recurring Schedule — All Occurrences (Series)
      type: object
      required: [recurring]
      properties:
        recurring:
          type: boolean
          enum: [true]
          description: Harus **true** untuk recurring meeting (edit seri).
        topic:
          type: string
          maxLength: 200
          description: Ubah judul/topik seri.
        passcode:
          type: string
          maxLength: 10
          description: Ubah passcode seri.
        start_time:
          type: string
          description: "Ubah jam mulai seluruh occurrence ke depan (HH:MM)."
        is_meeting_registration: { type: boolean }
        is_meeting_qna: { type: boolean }
        is_language_interpretation: { type: boolean }
        is_mute_participant_upon_entry: { type: boolean }
        is_req_permission_to_unmute_participants: { type: boolean }
      description: |-
        **Catatan:** `start_date` **tidak dapat diubah** untuk edit seri. 
        Seluruh field pola recurring (`recurrence`, `repeat_interval`, `weekly_days`, `monthly_day`, `monthly_week`, `end_type`, `end_date`, `end_after_type`) tidak didukung pada update seri.

    UpdateSingleOccurrenceBody:
      title: Recurring Schedule — Single Occurrence (This occurrence)
      type: object
      required: [recurring]
      properties:
        recurring:
          type: boolean
          enum: [true]
          description: Harus **true** untuk jadwal recurring (edit occurrence tunggal).
        start_date:
          type: string
          format: date
          description: "Tanggal occurrence (YYYY-MM-DD)."
        start_time:
          type: string
          description: "Jam occurrence (HH:MM)."
      description: |-
        **Gunakan query `occurrence_id`** pada URL. Hanya `start_date` dan/atau `start_time` yang diproses;
        field pola recurring akan **diabaikan**.

    # ---------- RESPONSE SCHEMAS ----------
    ScheduleUpdateSuccessResponse:
      type: object
      properties:
        response:
          type: object
          properties:
            status: { type: string, example: success }
            status_code: { type: integer, example: 200 }
            message: { type: string, example: Schedule updated successfully }
        data:
          $ref: "#/components/schemas/ScheduleItemFull"

    # Struktur detail jadwal penuh (dipakai ulang di berbagai endpoint)
    ScheduleItemFull:
      type: object
      properties:
        id: { type: integer }
        topic: { type: string }
        passcode: { type: string }
        recurring: { type: boolean }
        start_date: { type: string, format: date }
        start_time: { type: string }
        meeting_id: { type: string }
        occurence_id: { type: string, nullable: true }
        join_url: { type: string }
        registration_url: { type: string, nullable: true }
        waiting_room: { type: integer }
        is_meeting_registration: { type: boolean }
        is_meeting_qna: { type: boolean }
        is_language_interpretation: { type: boolean }
        is_mute_participant_upon_entry: { type: boolean }
        is_req_permission_to_unmute_participants: { type: boolean }
        editable: { type: boolean }
        is_used: { type: boolean }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
        product:
          type: object
          properties:
            id: { type: integer }
            name: { type: string }
            capacity: { type: integer }
        account:
          type: object
          properties:
            id: { type: integer }
            name: { type: string }
        recurring_data:
          type: object
          description: Rincian pengulangan (jika recurring).
          properties:
            total_recurring: { type: integer, nullable: true }
            recurrence: { type: integer, nullable: true }
            repeat_interval: { type: integer, nullable: true }
            monthly_day: { type: integer, nullable: true }
            monthly_week: { type: integer, nullable: true }
            weekly_days:
              type: array
              items: { type: integer }
              nullable: true
            end_type: { type: string, nullable: true }
            end_date: { type: string, format: date, nullable: true }
            end_after_type: { type: integer, nullable: true }
        occurrences:
          type: array
          items:
            type: object
            properties:
              id: { type: integer }
              occurence_id: { type: string }
              start_date: { type: string, format: date }
              start_time: { type: string }
              waiting_room: { type: integer }
              editable: { type: boolean }
              is_used: { type: boolean }
